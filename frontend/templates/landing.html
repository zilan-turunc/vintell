<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vintell AI</title>
  <style>
    :root{
      --bg:#fdf2f8;          /* soft pink background */
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --subtle:#64748b;
      --line:#fbcfe8;        /* light pink border */
      --brand:#3b82f6;       /* main blue */
      --brand-2:#ec4899;     /* vibrant pink */
      --ring: rgba(236,72,153,.25);  /* pink glow */
      --radius:16px;
      --shadow: 0 8px 30px rgba(236,72,153,.15);
    }
    /* Buttons: pink & blue gradient */
    button{
      appearance:none; 
      border:0; 
      border-radius:12px;
      padding:10px 14px; 
      font-weight:700; 
      cursor:pointer;
      color:white; 
      background:linear-gradient(135deg, var(--brand), var(--brand-2));
      box-shadow: 0 6px 16px rgba(236,72,153,.25);
      transition: transform .06s ease, filter .2s ease;
    }
    button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px)}

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;-webkit-font-smoothing:antialiased;letter-spacing:.2px}
    a{color:var(--brand); text-decoration:none}
    a:hover{text-decoration:underline}
    .shell{max-width:1100px; margin:0 auto; padding:28px 18px 80px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:24px}
    .logo{display:flex; align-items:center; gap:12px; font-weight:800}
    .logo .badge{display:inline-grid; place-items:center; width:40px; height:40px; border-radius:12px;background:linear-gradient(135deg, var(--brand), #8b5cf6); color:white}
    .logo span{font-size:20px}
    .sub{color:var(--subtle); font-size:13px}
    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:16px}
    .col-8{grid-column:span 8}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    @media (max-width: 980px){ .col-8,.col-6,.col-4{grid-column:1 / -1} }
    .card{background:var(--card);border:1px solid var(--line);border-radius: var(--radius);padding:18px;box-shadow: var(--shadow)}
    .card h2{margin:4px 0 8px; font-size:18px}
    .hint{color:var(--muted); font-size:13px; margin-top:-2px}
    .stack{display:flex; flex-direction:column; gap:10px; margin-top:6px}
    input[type="text"], textarea{width:100%; border-radius:12px; border:1px solid var(--line);background:#fff; color:var(--text); padding:12px 14px; outline:none;transition: box-shadow .15s,border-color .15s;font-size:15px}
    textarea{min-height:100px; resize:vertical}
    input[type="text"]:focus, textarea:focus{border-color: var(--brand);box-shadow: 0 0 0 4px var(--ring)}
    input[type="file"]{font-size:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    button{appearance:none; border:0; border-radius:12px;padding:10px 14px; font-weight:700; cursor:pointer;color:white; background:linear-gradient(180deg, var(--brand), var(--brand-2));box-shadow: 0 6px 16px rgba(37,99,235,.25);transition: transform .06s ease, filter .2s ease}
    button:hover{filter:brightness(1.03)}
    button:active{transform:translateY(1px)}
    button[disabled]{opacity:.7; cursor:not-allowed}
    .pill{padding:6px 10px; border-radius:999px; background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe; font-size:12px}
    .result{background:#f8fafc; border:1px solid var(--line);border-radius:14px; padding:14px; max-height:440px; overflow:auto;white-space: normal; word-wrap:break-word}
    .muted{color:var(--subtle)}
    footer{margin-top:24px; text-align:center; color:var(--muted); font-size:12px}
    .modal{position:fixed; inset:0; display:none; place-items:center; padding:20px; z-index:40}
    .modal[open]{display:grid}
    .scrim{position:absolute; inset:0; background:rgba(15,23,42,.45); backdrop-filter: blur(2px)}
    .dialog{position:relative; width:min(980px, 96vw); max-height:88vh; overflow:auto}
    .toolbar{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px}
    .close{background:#0ea5e9; border:0}
    .content{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; box-shadow:var(--shadow)}
    .twoCol{display:grid; grid-template-columns: 1fr 1.2fr; gap:14px}
    @media (max-width:760px){ .twoCol{grid-template-columns:1fr} }
    .queryBox{border:1px solid var(--line); border-radius:14px; padding:12px; background:#fff}
    .queryBox img{width:100%; height:auto; display:block; border-radius:12px}
    .resultBox{border:1px solid var(--line); border-radius:14px; padding:12px; background:#fff}
    .gridImgs{display:grid; grid-template-columns: repeat(auto-fill, minmax(130px,1fr)); gap:12px}
    .thumb{border:1px solid var(--line); border-radius:12px; overflow:hidden; background:#fff}
    .thumb img{width:100%; height:140px; object-fit:cover; display:block}
    .thumb .cap{padding:8px 10px; font-size:12px; color:var(--muted)}
    .warn{background:#fff7ed; color:#c2410c; border:1px solid #fed7aa; padding:10px 12px; border-radius:12px; font-size:14px}
    .list-item-1, .list-item-2 { display: block; }
    .list-item-1 { margin-left: 10px; }
    .list-item-2 { margin-left: 30px; }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="logo">
        <div class="badge">VA</div>
        <div>
          <span>Vintell AI</span><div class="sub">RAG • Image Search • Recommender • Moodboard</div>
        </div>
      </div>
    </header>

    <div class="grid">
      <section class="card col-8">
        <h2>Image Similarity Search</h2>
        <div class="hint">Upload an image. We’ll show similar items in a gallery.</div>
        <form id="img-form" class="stack" action="/image-search" method="post" enctype="multipart/form-data">
          <input type="file" name="image_file" accept="image/*" required />
          <button type="submit">Find Similar</button>
        </form>
      </section>

      <section class="card col-4">
        <h2>Ask RAG (Streaming)</h2>
        <div class="hint">Query your indexed docs. Tokens stream below.</div>
        <form id="rag-form" class="stack" autocomplete="off">
          <input type="text" id="rag-query" placeholder="What are the latest fashion trends?" required />
          <div class="row">
            <button id="rag-submit" type="submit">Ask</button>
            <span class="pill" id="rag-status">Idle</span>
          </div>
          <div class="result" id="rag-output">Ask something ✨</div>
        </form>
      </section>

      <section class="card col-6">
        <h2>Text → Fashion Recommender</h2>
        <div class="hint">Describe an item and get styled suggestions.</div>
        <form id="ttf-form" class="stack" action="/text-to-fashion" method="post">
          <textarea name="description" placeholder="e.g., pink princess skirt with tulle"></textarea>
          <button type="submit">Suggest Items</button>
        </form>
        <div class="result muted" id="ttf-result">Results appear here.</div>
      </section>

      <section class="card col-6">
        <h2>Moodboard Hashtag Generator</h2>
        <div class="hint">We’ll craft concise tags + pairings.</div>
        <form id="tags-form" class="stack" action="/moodboard-tags" method="post">
          <input type="text" name="style_description" placeholder="e.g., red blouse" required />
          <button type="submit">Generate Tags</button>
        </form>
        <div class="result muted" id="tags-result">Results appear here.</div>
      </section>
    </div>

    <footer>© Vintell • Built for clarity and taste</footer>
  </div>

  <dialog class="modal" id="modal">
    <div class="scrim" data-close></div>
    <div class="dialog">
      <div class="toolbar">
        <span class="pill" id="modal-title">Image Search</span>
        <button class="close" data-close>Close</button>
      </div>
      <div class="content">
        <div class="twoCol">
          <div>
            <h3 style="margin:6px 0 10px;">Query Image</h3>
            <div class="queryBox"><img id="query-preview" alt="query image"/></div>
          </div>
          <div>
            <h3 style="margin:6px 0 10px;">Most similar → least</h3>
            <div id="img-warn" class="warn" style="display:none"></div>
            <div id="gallery" class="gridImgs"></div>
          </div>
        </div>
      </div>
    </div>
  </dialog>

  <script>
    const ragForm = document.getElementById('rag-form');
    const ragQuery = document.getElementById('rag-query');
    const ragOutput = document.getElementById('rag-output');
    const ragSubmit = document.getElementById('rag-submit');
    const ragStatus = document.getElementById('rag-status');
    ragForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const q = ragQuery.value.trim();
      if(!q) return;
      ragOutput.textContent = '';
      ragSubmit.disabled = true;
      ragStatus.textContent = 'Streaming…';
      const eventSource = new EventSource(`/rag-stream-proxy?q=${encodeURIComponent(q)}`);
      eventSource.addEventListener('token', (ev)=>{ ragOutput.textContent += ev.data; });
      eventSource.addEventListener('done', ()=>{ ragSubmit.disabled = false; ragStatus.textContent = 'Done'; eventSource.close(); });
      eventSource.addEventListener('error', ()=>{ ragOutput.textContent += "\n\n[Error connecting to stream]"; ragSubmit.disabled = false; ragStatus.textContent = 'Error'; eventSource.close(); });
    });

    const modal = document.getElementById('modal');
    modal.addEventListener('click', (e)=>{ if(e.target.hasAttribute('data-close')) modal.close(); });
    const qPreview = document.getElementById('query-preview');
    const gallery = document.getElementById('gallery');
    const warn = document.getElementById('img-warn');

    const KNOWN_BASES = ['/backend/rag/images/', '/rag/images/', '/images/', '/static/images/', '/static/', '/uploads/'];

    function clearGallery(){ gallery.innerHTML = ''; warn.style.display = 'none'; warn.textContent = ''; }
    function addThumb(src, caption){
      const card = document.createElement('div'); card.className = 'thumb';
      const img = document.createElement('img'); img.loading = 'lazy'; img.src = src;
      const cap = document.createElement('div'); cap.className = 'cap'; cap.textContent = caption || src.split('/').pop();
      card.append(img, cap); gallery.append(card);
    }

    async function tryHead(url){
      try{ const r = await fetch(url, {method:'HEAD'}); return r.ok; }catch{return false}
    }

    function sanitizeName(s){ return s.trim().replace(/^\s*[-•*]\s*/,'').replaceAll(' ', '_'); }

    // Build a mapping from meta.json if accessible
    async function loadMetaMap(){
      const candidates = ['/rag/img_index/meta.json','/backend/rag/img_index/meta.json','/static/rag/img_index/meta.json'];
      for (const c of candidates){
        try{
          const r = await fetch(c); if(!r.ok) continue;
          const meta = await r.json();
          const map = new Map();
          meta.forEach((m)=>{
            const p = (m.path || m.image || m.image_path || '').toString();
            if(!p) return;
            const file = p.split(/[\\/]/).pop();
            const stem = file.replace(/\.[^.]+$/,'').toLowerCase();
            map.set(stem, p);
          });
          return map;
        }catch{}
      }
      return null;
    }

    function toUrlFromMetaPath(metaPath){
      // Convert common meta paths to URL paths
      if(/^https?:\/\//i.test(metaPath)) return metaPath;
      const s = metaPath.replaceAll('\\','/');
      if (s.startsWith('/')) return s;
      if (s.startsWith('backend/rag/images/')) return '/' + s;
      if (s.startsWith('rag/images/')) return '/backend/' + s; // most deployments
      if (s.startsWith('images/')) return '/images/' + s.slice(7);
      return '/backend/rag/images/' + s.split('/').pop();
    }

    async function resolveNameToUrl(name, metaMap){
      const clean = sanitizeName(name);
      const stem = clean.toLowerCase().replace(/\.[^.]+$/,'');
      if (metaMap && metaMap.has(stem)){
        return toUrlFromMetaPath(metaMap.get(stem));
      }
      const exts = ['.jpg','.jpeg','.png','.webp','.JPG','.PNG'];
      for (const base of KNOWN_BASES){
        for (const ext of exts){
          const url = base + stem + ext;
          if (await tryHead(url)) return url;
        }
      }
      return null;
    }

    const imgForm = document.getElementById('img-form');
    imgForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      clearGallery();
      modal.showModal();
      const file = imgForm.querySelector('input[type="file"]').files[0];
      qPreview.src = file ? URL.createObjectURL(file) : '';

      const fd = new FormData(imgForm);
      try{
        const res = await fetch(imgForm.action, { method:'POST', body: fd });
        const text = await res.text();

        // Try JSON first
        try{
          const data = JSON.parse(text);
          const qUrl = data.query_image_url || data.query_image || data.query;
          if(qUrl) qPreview.src = qUrl;
          if(Array.isArray(data.results) && data.results.length){
            data.results.forEach((r,i)=>{
              const src = r.image_url || r.url || r.path || r.filename || r.name;
              if(src) addThumb(src, r.label || r.name || `#${i+1}`);
            });
            return;
          }
        }catch{}

        // Parse HTML for <img>
        const tpl = document.createElement('template'); tpl.innerHTML = text;
        const imgs = Array.from(tpl.content.querySelectorAll('img'));
        if(imgs.length){ imgs.forEach((img,i)=> addThumb(img.getAttribute('src'), img.getAttribute('alt') || `#${i+1}`)); return; }

        // Parse <li> names and resolve via meta.json or HEAD guesses
        const items = Array.from(tpl.content.querySelectorAll('li')).map(li=>li.textContent.trim()).filter(Boolean);
        if(items.length){
          const metaMap = await loadMetaMap();
          const urls = await Promise.all(items.map(name => resolveNameToUrl(name, metaMap)));
          const hits = urls.map((u,i)=>({u,i})).filter(x=>!!x.u);
          if(hits.length){
            hits.forEach(({u,i})=> addThumb(u, items[i]));
            const misses = urls.map((u,i)=>u?null:items[i]).filter(Boolean);
            if(misses.length){ warn.style.display='block'; warn.textContent = `Missing images: ${misses.slice(0,6).join(', ')}${misses.length>6?' …':''}`; }
            return;
          }
        }

        warn.style.display='block'; warn.innerHTML='Could not parse results. Raw response:';
        const raw = document.createElement('div'); raw.className='warn'; raw.style.marginTop='12px'; raw.innerHTML=text.replaceAll('<','&lt;').replaceAll('>','&gt;');
        gallery.append(raw);
      }catch(err){
        warn.style.display='block'; warn.textContent='Something went wrong while fetching results.';
      }
    });
    
    function formatServerResponse(text) {
      // A simple function to convert key markdown elements to HTML
      return text
        // Convert ### headers to <h3> tags
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        // Convert **bold** text to <strong> tags
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Convert nested list items "- - Text"
        .replace(/^\s*-\s-\s(.*$)/gm, '<span class="list-item-2">&bull; $1</span>')
        // Convert top-level list items "- Text"
        .replace(/^\s*-\s(.*$)/gm, '<span class="list-item-1">&bull; $1</span>')
        // Convert numbered list items "1. Text"
        .replace(/^\s*(\d+\.)\s(.*$)/gm, '<span class="list-item-1">$1 $2</span>')
        // Finally, convert newlines to <br> tags to preserve line breaks
        .replace(/\n/g, '<br/>');
    }

    const ttfForm = document.getElementById('ttf-form');
    const ttfResult = document.getElementById('ttf-result');
    ttfForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      ttfResult.textContent = 'Working…';
      const fd = new FormData(ttfForm);
      try{
        const res = await fetch(ttfForm.action, { method:'POST', body: fd });
        const text = await res.text();
        ttfResult.classList.remove('muted');
        ttfResult.innerHTML = formatServerResponse(text);
      }catch{ ttfResult.textContent = 'Something went wrong.'; }
    });

    const tagsForm = document.getElementById('tags-form');
    const tagsResult = document.getElementById('tags-result');
    tagsForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      tagsResult.textContent = 'Working…';
      const fd = new FormData(tagsForm);
      try{
        const res = await fetch(tagsForm.action, { method:'POST', body: fd });
        const text = await res.text();
        tagsResult.classList.remove('muted');
        tagsResult.innerHTML = formatServerResponse(text);
      }catch{ tagsResult.textContent = 'Something went wrong.'; }
    });
  </script>
</body>
</html>